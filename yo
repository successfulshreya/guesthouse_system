euzu omkt kgxh ysod




book_room.php
<?php
session_start();
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'user') {
    header("Location: ../index.php");
    exit();
}
include '../db_connect.php';

// Helper to output an error and stop
function show_error($msg) {
    echo "<!DOCTYPE html><html><head>
            <title>Error</title>
            <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'>
          </head><body>
          <div class='container mt-5'>
            <div class='alert alert-danger'>" . htmlspecialchars($msg) . "</div>
            <a href='availability.php' class='btn btn-secondary'>Back to Availability</a>
          </div>
          </body></html>";
    exit();
}

// If GET: show booking form
if ($_SERVER['REQUEST_METHOD'] === 'GET') {
    if (!isset($_GET['guesthouse_id'], $_GET['room_id'], $_GET['checkin_date'], $_GET['checkout_date'])) {
        show_error("Missing booking parameters.");
    }
    $guesthouse_id = intval($_GET['guesthouse_id']);
    $room_id = intval($_GET['room_id']);
    $checkin = $_GET['checkin_date'];
    $checkout = $_GET['checkout_date'];

    // Optional: you can check availability here again to prevent hacking
    $stmt = $conn->prepare("
        SELECT 1 FROM bookings
        WHERE room_id = ?
          AND checkin_date < ?
          AND checkout_date > ?
        LIMIT 1
    ");
    $stmt->bind_param("iss", $room_id, $checkout, $checkin);
    $stmt->execute();
    $stmt->store_result();
    if ($stmt->num_rows > 0) {
        $stmt->close();
        show_error("Sorry, that room is no longer available for the selected dates.");
    }
    $stmt->close();

    ?>
    <!DOCTYPE html>
    <html>
    <head>
        <title>Confirm Booking</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body>
    <div class="container mt-4">
      <h2>Confirm Booking</h2>
      <form method="POST" action="book_room.php">
          <input type="hidden" name="guesthouse_id" value="<?= htmlspecialchars($guesthouse_id) ?>">
          <input type="hidden" name="room_id" value="<?= htmlspecialchars($room_id) ?>">
          <input type="hidden" name="checkin_date" value="<?= htmlspecialchars($checkin) ?>">
          <input type="hidden" name="checkout_date" value="<?= htmlspecialchars($checkout) ?>">

          <div class="mb-3">
              <label for="guest_name" class="form-label">Guest Name</label>
              <input type="text" class="form-control" id="guest_name" name="guest_name" required>
          </div>
          <div class="mb-3">
              <label for="guest_designation" class="form-label">Guest Designation</label>
              <input type="text" class="form-control" id="guest_designation" name="guest_designation" required>
          </div>
          <button type="submit" class="btn btn-primary">Book</button>
          <a href="availability.php?guesthouse_id=<?= urlencode($guesthouse_id) ?>&checkin=<?= urlencode($checkin) ?>&checkout=<?= urlencode($checkout) ?>" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
    </html>
    <?php
    exit();
}

// If POST: process booking
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $required = ['guesthouse_id', 'room_id', 'checkin_date', 'checkout_date', 'guest_name', 'guest_designation'];
    foreach ($required as $f) {
        if (!isset($_POST[$f]) || trim($_POST[$f]) === '') {
            show_error("Missing or invalid field: $f");
        }
    }

    $guesthouse_id = intval($_POST['guesthouse_id']);
    $room_id = intval($_POST['room_id']);
    $checkin = $_POST['checkin_date'];
    $checkout = $_POST['checkout_date'];
    $guest_name = trim($_POST['guest_name']);
    $guest_designation = trim($_POST['guest_designation']);

    // Validate dates
    $today = date('Y-m-d');
    if ($checkin < $today) {
        show_error("Check-in date cannot be in the past.");
    }
    if ($checkout <= $checkin) {
        show_error("Check-out must be after check-in.");
    }

    // Check that the room belongs to the guesthouse
    $stmt = $conn->prepare("SELECT id FROM rooms WHERE id = ? AND guesthouse_id = ?");
    $stmt->bind_param("ii", $room_id, $guesthouse_id);
    $stmt->execute();
    $res = $stmt->get_result();
    if ($res->num_rows === 0) {
        $stmt->close();
        show_error("Invalid room / guesthouse selection.");
    }
    $stmt->close();

    // Check overlapping booking
    $stmt2 = $conn->prepare("
        SELECT 1 FROM bookings
        WHERE room_id = ?
          AND checkin_date < ?
          AND checkout_date > ?
        LIMIT 1
    ");
    $stmt2->bind_param("iss", $room_id, $checkout, $checkin);
    $stmt2->execute();
    $stmt2->store_result();
    if ($stmt2->num_rows > 0) {
        $stmt2->close();
        show_error("Room is already booked during selected dates.");
    }
    $stmt2->close();

    // Insert booking
    $user_id = $_SESSION['user_id'];
    $stmt3 = $conn->prepare("
        INSERT INTO bookings (user_id, room_id, guest_name, guest_designation, checkin_date, checkout_date)
        VALUES (?, ?, ?, ?, ?, ?)
    ");
    $stmt3->bind_param("iissss",
        $user_id,
        $room_id,
        $guest_name,
        $guest_designation,
        $checkin,
        $checkout
    );
    $ok = $stmt3->execute();
    if (!$ok) {
        // optionally log error: $stmt3->error
        show_error("Failed to book room. Please try later.");
    }
    $stmt3->close();

    // Success
    echo "<!DOCTYPE html><html><head>
            <title>Booking Confirmed</title>
            <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' rel='stylesheet'>
          </head><body>
          <div class='container mt-5'>
            <div class='alert alert-success'>Booking confirmed successfully.</div>
            <a href='my_booking.php' class='btn btn-primary'>Go to My Bookings</a>
          </div>
          </body></html>";
    exit();
}

// Fallback
show_error("Unsupported request method.");
?>




















book_room.php updated after 

<?php
session_start();
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'user') {
    header("Location: ../index.php");
    exit();
}

include '../db_connect.php';
include '../includes/mail_config.php';

// fetch guesthouses
$gh_result = $conn->query("SELECT id, name, address FROM guesthouses ORDER BY name");

$msg = '';
if (isset($_GET['success'])) {
    $msg = "Room booked successfully!";
}

// handle booking submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $user_id = $_SESSION['user_id'];
    $guesthouse_id = intval($_POST['guesthouse_id']);
    $room_id = intval($_POST['room_id']);
    $checkin_date = trim($_POST['checkin_date']);
    $checkout_date = trim($_POST['checkout_date']);
    $guest_name = trim($_POST['guest_name']);
    $guest_designation = trim($_POST['guest_designation']);

    if ($guesthouse_id && $room_id && $checkin_date && $checkout_date && $guest_name) {
        // check room availability
        $stmt = $conn->prepare("SELECT id FROM bookings WHERE room_id = ? AND checkin_date < ? AND checkout_date > ? AND status IN ('pending','approved')");
        $stmt->bind_param("iss", $room_id, $checkout_date, $checkin_date);
        $stmt->execute();
        $stmt->store_result();

        if ($stmt->num_rows > 0) {
            $msg = "Room is already booked for the selected dates.";
        } else {
            $stmt->close();

            // insert booking with guest info and pending status
            $stmt = $conn->prepare(
                "INSERT INTO bookings (user_id, room_id, checkin_date, checkout_date, guest_name, guest_designation, status)
                 VALUES (?, ?, ?, ?, ?, ?, 'pending')"
            );
            $stmt->bind_param("iissss", $user_id, $room_id, $checkin_date, $checkout_date, $guest_name, $guest_designation);

            if ($stmt->execute()) {
                $stmt->close();

                // âœ… abhi yaha mail bhejna hai
                $admin_email = "shreyasahuu01@gmail.com";
                $subject = "New Room Booking Request";
                $body = "<h3>New Room Booking Request</h3>
                         <p>User <b>{$user_id}</b> has made a new booking request for room <b>{$room_id}</b>.</p>
                         <p>Check-in: {$checkin_date}</p>
                         <p>Check-out: {$checkout_date}</p>
                         <p>Guest Name: {$guest_name}</p>
                         <p>Guest Designation: {$guest_designation}</p>";

                sendMail($admin_email, $subject, $body);

                // mark room as booked
                $up = $conn->prepare("UPDATE rooms SET status='booked' WHERE id=?");
                $up->bind_param("i", $room_id);
                $up->execute();
                $up->close();

                header("Location: book_room.php?success=1");
                exit();
            } else {
                $msg = "Error: " . htmlspecialchars($stmt->error);
            }
        }
        $stmt->close();
    } else {
        $msg = "Please fill all required fields (Guest Name, Guesthouse, Room, Dates).";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Book Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <script>
        // Fetch rooms dynamically based on guesthouse
        function loadRooms(guesthouseId) {
            if (!guesthouseId) {
                document.getElementById("roomSelect").innerHTML = "<option value=''>Select guesthouse first</option>";
                return;
            }
            fetch("get_room.php?guesthouse_id=" + guesthouseId)
            .then(res => res.text())
            .then(data => {
                document.getElementById("roomSelect").innerHTML = data;
            })
            .catch(err => console.error("Error fetching rooms:", err));
        }
    </script>
    <style>
      body {
        min-height: 100vh;
        display: flex;
      }
      .sidebar {
        width: 220px;
        background: #343a40;
        color: #fff;
        flex-shrink: 0;
      }
      .sidebar .nav-link { color: #ddd; }
      .sidebar .nav-link.active { background: #495057; color: #fff; }
      .sidebar .nav-link:hover { background: #495057; color: #fff; }
      .sidebar .nav-link i { margin-right: 8px; }
      .main-content { flex-grow: 1; padding: 20px; }
      .topbar {
        height: 60px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        border-bottom: 1px solid #e0e0e0;
      }
      .card-action { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
      .card-action:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar d-flex flex-column p-3">
    <a href="#" class="d-flex align-items-center mb-3 text-white text-decoration-none">
      <i class="bi bi-gear-fill fs-4"></i>
      <span class="fs-4">User Panel</span>
    </a>
    <hr>
    <ul class="nav nav-pills flex-column">
      <li class="nav-item"><a href="Dashboard.php" class="nav-link"><i class="bi bi-building"></i> Dashboard</a></li>
      <li class="nav-item"><a href="availability.php" class="nav-link"><i class="bi bi-building"></i> Availability</a></li>
      <li class="nav-item"><a href="my_booking.php" class="nav-link"><i class="bi bi-door-open"></i> My Bookings</a></li>
      <li class="nav-item"><a href="book_room.php" class="nav-link active"><i class="bi bi-calendar-check"></i> Book Room</a></li>
      <li class="nav-item mt-auto"><a href="../logout.php" class="nav-link"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
    </ul>
  </nav>

  <!-- Main content area -->
  <div class="main-content">
    <div class="topbar">
      <h5>Dashboard</h5>
      <h4>SARDA ENERY and MINERALS LTD</h4>
      <div><span class="me-3">Welcome, User</span></div>
    </div>

    <div class="container mb-3"><br>
      <h2 class="mt-3 mb-3">Book Rooms for Guests</h2>

      <?php if (!empty($msg)): ?>
          <div class='alert alert-info'><?= htmlspecialchars($msg) ?></div>
      <?php endif; ?>

      <form method="POST">
          <div class="mb-3">
              <label for="guest_name" class="form-label">Guest Name</label>
              <input type="text" name="guest_name" id="guest_name" class="form-control" required>
          </div>

          <div class="mb-3">
              <label for="guest_designation" class="form-label">Guest Designation</label>
              <input type="text" name="guest_designation" id="guest_designation" class="form-control">
          </div>

          <div class="mb-3">
              <label for="guesthouse_id" class="form-label">Guesthouse</label>
              <select name="guesthouse_id" id="guesthouse_id" class="form-control" required onchange="loadRooms(this.value)">
                  <option value="">Select a guesthouse</option>
                  <?php
                  if ($gh_result) {
                      while ($row = $gh_result->fetch_assoc()) {
                          echo '<option value="' . intval($row['id']) . '">' . htmlspecialchars($row['name']) . '</option>';
                      }
                  }
                  ?>
              </select>
          </div>

          <div class="mb-3">
              <label for="room_id" class="form-label">Room</label>
              <select name="room_id" id="roomSelect" class="form-control" required>
                  <option value="">Select a room</option>
              </select>
          </div>

          <div class="mb-3">
              <label for="checkin_date" class="form-label">Check-in Date</label>
              <input type="date" name="checkin_date" id="checkin_date" class="form-control" required>
          </div>

          <div class="mb-3">
              <label for="checkout_date" class="form-label">Check-out Date</label>
              <input type="date" name="checkout_date" id="checkout_date" class="form-control" required>
          </div>

          <button class="btn btn-primary">Book Room</button>
          <a href="dashboard.php" class="btn btn-secondary">Back</a>
      </form>
    </div>
  </div>
</body>
</html>


new availability live for dashbo
<?php 
session_start();
include '../db_connect.php';

$guesthouse_id = 13; 

// Prepare the SQL statement.
$sql = "SELECT r.id, r.room_id, IF(b.id IS NOT NULL, 'booked', 'available') AS today_status 
        FROM rooms r
        LEFT JOIN bookings b ON r.id = b.room_id AND CURDATE() BETWEEN b.checkin_date AND b.checkout_date 
        WHERE r.guesthouse_id = ?";
$stmt = $conn->prepare($sql);

// Check for a preparation error.
if ($stmt === false) {
    die('Prepare failed: ' . htmlspecialchars($conn->error));
}

// Bind the parameter. The correct syntax is "$stmt->bind_param(...)".
$stmt->bind_param("i", $guesthouse_id);

// Execute the statement.
$stmt->execute();

// Get the result.
$result = $stmt->get_result();
?>

<!DOCTYPE html>
<html>
    <head>
        <title>Today's Availability</title>
        <style>
            /* Basic styling for the room display */
            .room-box {
                margin: 5px;
                padding: 10px;
                width: 120px;
                border: 1px solid #ccc;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <h3>Today's Room Availability</h3>
        <div style="display:flex; flex-wrap:wrap;">
            <?php 
            // The while loop must enclose the HTML content you want to repeat.
            while ($row = $result->fetch_assoc()) {
            ?>
                <div class="room-box" style="background-color: <?= $row['today_status'] == 'available' ? '#a8f0a3' : '#f0a3a3'; ?>;">
                    <?= htmlspecialchars($row['room_id']) ?><br>
                    <strong><?= ucfirst($row['today_status']) ?></strong>
                </div>
            <?php 
            } // Close the while loop here.
            ?>
        </div>
    </body>
</html>

<?php
// Close the statement and connection when you're done.
$stmt->close();
$conn->close();
?>

